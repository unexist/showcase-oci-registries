version: '3'

tasks:
  container:
    internal: true
    cmds:
      - |
        podman run --rm -v .:/workspace --name cosign --network=host \
          ghcr.io/sigstore/cosign/cosign:v2.4.1 {{.ARGS}}

  blob:
    cmds:
      - task: container
        vars: { ARGS: "upload blob -f /workspace/todo-service/{{.BINARY_FILE}} {{.REGISTRY_URL}}/{{.ARTIFACT_NAME}}-cosign" }

  sbom:
    cmds:
      - task: container
        vars: { ARGS: "attest --yes --type cyclonedx --predicate /workspace/{{.SBOM_FILE}} {{.REGISTRY_URL}}/{{.ARTIFACT_NAME}}-cosign" }

  sign:
    cmds:
      - task: container
        vars: { ARGS: "sign-blob --yes {{.REGISTRY_URL}}/{{.ARTIFACT_NAME}}-cosign" }