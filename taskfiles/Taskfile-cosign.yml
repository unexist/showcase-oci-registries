version: '3'

env:
  COSIGN_PASSWORD: '{{.COSIGN_PASSWORD | default ""}}'
  OIDC_ISSUER: '{{.OIDC_ISSUER | default "https://github.com/login/oauth"}}'
  OIDC_IDENTITY: '{{.OIDC_IDENTITY | default "christoph@unexist.dev"}}'

tasks:
  container:
    internal: true
    cmds:
      - |
        podman run --rm -v .:/workspace --name cosign --network=host \
          -e COSIGN_PASSWORD={{.COSIGN_PASSWORD}} \
          ghcr.io/sigstore/cosign/cosign:v2.4.1 {{.ARGS}}

  blob:
    cmds:
      - task: container
        vars: { ARGS: "upload blob -f /workspace/todo-service/{{.BINARY_FILE}} \
          {{.REGISTRY_URL}}/{{.ARTIFACT_NAME}}-cosign" }

  sbom:
    cmds:
      - task: container
        vars: { ARGS: "attest-blob --yes \
          --type https://cyclonedx.org/bom/v1.6 \
          --predicate /workspace/{{.SBOM_FILE}} \
          /workspace/todo-service/{{.BINARY_FILE}}" }
    #sources:
    #  - {{.SBOM_FILE}}
    #generates:
    #  - sbom.att

  sign:
    cmds:
      - task: container
        vars: { ARGS: "sign --yes {{.REGISTRY_URL}}/{{.ARTIFACT_NAME}}-cosign" }

  verify-local:
    deps: [sign]
    cmds:
      - task: container
        vars: { ARGS: "verify-blob --bundle /workspace/cosign.bundle \
          --certificate-oidc-issuer={{.OIDC_ISSUER}} \
          --certificate-identity={{.OIDC_IDENTITY}}  \
          /workspace/todo-service/{{.BINARY_FILE}}" }

  sign-local:
    cmds:
      - task: container
        vars: { ARGS: "sign-blob --yes --bundle /workspace/cosign.bundle \
          /workspace/todo-service/{{.BINARY_FILE}}" }
    status:
      - test -s cosign.bundle
