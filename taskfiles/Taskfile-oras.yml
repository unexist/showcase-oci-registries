version: '3'

tasks:
  container:
    internal: true
    cmds:
      - |
        podman run --rm -v .:/workspace -it --name oras --network=host \
          ghcr.io/oras-project/oras:main {{.ARGS}} --plain-http

  push:
    cmds:
      - task: container
        vars: { ARGS: "push --artifact-type {{.ARTIFACT_TYPE}} {{.REGISTRY_URL}}/{{.ARTIFACT_NAME}}-oras:{{.VERSION}} todo-service/{{.BINARY_FILE}}" }

  pull:
    cmds:
      - task: container
        vars: { ARGS: "pull {{.REGISTRY_URL}}/{{.ARTIFACT_NAME}}-oras:{{.VERSION}}" }

  blob:
    cmds:
      - task: container
        vars: { ARGS: "blob push --descriptor --pretty {{.REGISTRY_URL}}/{{.ARTIFACT_NAME}}-oras todo-service/{{.BINARY_FILE}}" }

  sbom:
    cmds:
      - task: container
        vars: { ARGS: "attach --artifact-type {{.ARTIFACT_SBOM_TYPE}} {{.REGISTRY_URL}}/{{.ARTIFACT_NAME}}-oras:{{.VERSION}} {{.SBOM_FILE}}" }

  annotate:
    cmds:
      - task: container
        vars: { ARGS: "push --annotation {{.ARGS}} {{.REGISTRY_URL}}/{{.ARTIFACT_NAME}}-oras:{{.VERSION}} todo-service/{{.BINARY_FILE}}" }

  list:
    cmds:
      - task: container
        vars: { ARGS: "repo list {{.REGISTRY_URL}}" }

  discover:
    cmds:
      - task: container
        vars: { ARGS: "discover {{.REGISTRY_URL}}/{{.ARTIFACT_NAME}}-oras:{{.VERSION}}" }